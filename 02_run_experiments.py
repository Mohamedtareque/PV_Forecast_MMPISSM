"""Experiment runner for the LSTM baseline."""

import argparse
from typing import List, Optional

import torch

from src.config import (
    FEATURE_SETS,
    LSTM_CONFIG,
    MATNET_CONFIG,
    resolve_feature_list,
)
from src.pipeline import SolarForecastingPipeline


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Run LSTM experiment with configurable features.")
    parser.add_argument(
        "--feature-set",
        type=str,
        choices=sorted(FEATURE_SETS.keys()),
        help="Predefined feature group to use.",
    )
    parser.add_argument(
        "--features",
        nargs="+",
        help="Explicit feature list for the model input (overrides --feature-set).",
    )
    parser.add_argument(
        "--model",
        type=str,
        choices=["lstm", "matnet"],
        default="lstm",
        help="Model architecture preset to run.",
    )
    parser.add_argument(
        "--data-prefix",
        type=str,
        help="Prefix for preprocessed arrays. Must match the output of 01_prepare_data.py.",
    )
    parser.add_argument(
        "--experiment-name",
        type=str,
        help="Optional override for the experiment name.",
    )
    return parser.parse_args()


def determine_features(feature_set: Optional[str], features: Optional[List[str]]) -> List[str]:
    if features:
        return [f.strip() for f in features]
    return resolve_feature_list(feature_set)


def infer_data_prefix(feature_set: Optional[str], explicit_prefix: Optional[str], default_prefix: str) -> str:
    if explicit_prefix:
        return explicit_prefix
    if feature_set:
        return f"solar_kbins_{feature_set}"
    return default_prefix


def main():
    args = parse_args()
    device = (
    "cuda"
    if torch.cuda.is_available()
    else "mps"
    if hasattr(torch.backends, "mps") and torch.backends.mps.is_available()
    else "cpu"
)

    config_map = {
        "lstm": LSTM_CONFIG,
        "matnet": MATNET_CONFIG,
    }
    base_config = config_map[args.model].copy()
    base_config["device"] = device

    feature_cols = determine_features(args.feature_set, args.features)
    if args.features and not args.data_prefix:
        raise SystemExit(
            "Custom feature list detected. Please provide --data-prefix that matches the "
            "arrays generated by 01_prepare_data.py."
        )
    base_config["feature_cols"] = feature_cols
    base_config["feature_selection"] = args.feature_set

    base_config["data_prefix"] = infer_data_prefix(
        args.feature_set,
        args.data_prefix,
        base_config.get("data_prefix", "solar_kbins"),
    )

    if args.experiment_name:
        base_config["experiment_name"] = args.experiment_name

    print("\n" + "=" * 50 + f"\nRunning {args.model.upper()} Experiment\n" + "=" * 50)
    print(f"Device: {device}")
    print(f"Data prefix: {base_config['data_prefix']}")
    print(f"Feature columns ({len(feature_cols)}): {feature_cols}")

    pipeline = SolarForecastingPipeline(base_config)
    _, summary = pipeline.run()
    print(f"\nResults saved to: {pipeline.tracker.exp_dir}")

    avg_metrics = summary.get("average_metrics", {})
    val_metrics = avg_metrics.get("validation") if isinstance(avg_metrics, dict) else None
    if val_metrics:
        print("\nValidation metrics (mean ± std):")
        for metric, stats in val_metrics.items():
            print(f"  {metric}: {stats['mean']:.6f} ± {stats['std']:.6f}")


if __name__ == "__main__":
    main()
